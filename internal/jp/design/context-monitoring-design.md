# コンテキストモニタリングシステム - 詳細設計書

**日付:** 2025-01-09 | **バージョン:** 1.0  
**機能名:** コンテキストモニタリングシステム

## 📐 アーキテクチャ概要

### システムアーキテクチャ
```
┌─────────────────────────────────────────────────────────┐
│                   Claude Codeセッション                   │
├─────────────────────────────────────────────────────────┤
│                      フックレイヤー                        │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐  │
│  │ユーザー入力│ │ツール呼出│ │レスポンス│ │セッション│  │
│  │  フック    │ │  フック  │ │  フック  │ │  フック  │  │
│  └────┬─────┘ └────┬────┘ └────┬────┘ └────┬─────┘  │
└───────┼────────────┼───────────┼───────────┼──────────┘
        │            │           │           │
        ▼            ▼           ▼           ▼
┌─────────────────────────────────────────────────────────┐
│              コンテキストモニタリングコア                  │
│  ┌─────────────────────────────────────────────────┐   │
│  │            イベントプロセッサー                    │   │
│  └─────────────────────────────────────────────────┘   │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌────────┐   │
│  │トークン   │ │コンテキスト│ │ファイル  │ │パターン│   │
│  │カウンター │ │アナライザー│ │トラッカー│ │検出器  │   │
│  └──────────┘ └──────────┘ └──────────┘ └────────┘   │
└─────────────────────────────────────────────────────────┘
        │            │           │           │
        ▼            ▼           ▼           ▼
┌─────────────────────────────────────────────────────────┐
│                   データレイヤー                          │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐   │
│  │   SQLite     │ │  JSONキャッシュ│ │  ログファイル│   │
│  │ データベース  │ │              │ │              │   │
│  └──────────────┘ └──────────────┘ └──────────────┘   │
└─────────────────────────────────────────────────────────┘
        │            │           │
        ▼            ▼           ▼
┌─────────────────────────────────────────────────────────┐
│                プレゼンテーションレイヤー                 │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐   │
│  │ダッシュボード │ │     CLI      │ │     API      │   │
│  │   (Web UI)   │ │   コマンド    │ │  (NPMパッケージ)│   │
│  └──────────────┘ └──────────────┘ └──────────────┘   │
└─────────────────────────────────────────────────────────┘
```

## 🎨 コンポーネント設計

### 1. フック統合レイヤー

各フックはClaude Codeのイベントをキャプチャし、モニタリングシステムに転送します。

### 2. コアモジュール

#### TokenCounter（トークンカウンター）
- **役割**: テキストのトークン数を正確にカウント
- **技術**: tiktokenライブラリを使用（OpenAIモデル用）
- **最適化**: LRUキャッシュで頻出テキストの再計算を回避

#### ContextAnalyzer（コンテキストアナライザー）
- **役割**: コンテキストサイズを監視し、制限接近時にアラート
- **閾値**: 警告80%、危機的90%
- **推奨**: コンテキスト使用量に基づく最適化提案を生成

#### FileTracker（ファイルトラッカー）
- **役割**: ファイルアクセスを追跡し、冗長な読み込みを検出
- **分析**: ファイルごとのトークンコストを計算
- **最適化**: キャッシング戦略の提案

#### PatternDetector（パターン検出器）
- **役割**: 会話ループと非効率なパターンを検出
- **分析**: セッション効率とタスク完了率を評価
- **洞察**: 最適なセッション長と改善点を特定

### 3. データレイヤー

#### データベーススキーマ設計

**セッションテーブル**
- セッション開始/終了時刻
- 総トークン使用量
- 使用モデル
- セッションステータス

**メッセージテーブル**
- セッションID（外部キー）
- ロール（user/assistant）
- コンテンツ
- トークン数
- タイムスタンプ

**ファイルアクセステーブル**
- セッションID（外部キー）
- ファイルパス
- 操作タイプ（読み/書き）
- トークンコスト
- 冗長フラグ

**メトリクステーブル**
- セッションID（外部キー）
- メトリクスタイプ
- 値
- タイムスタンプ

### 4. ダッシュボード実装

#### WebSocketサーバー
- **ポート**: 3000（HTTP）、3001（WebSocket）
- **更新頻度**: 最大1Hz（過負荷防止）
- **認証**: オプションのベーシック認証

#### ダッシュボードUI
- **リアルタイム更新**: WebSocket経由
- **視覚化**: Chart.jsによるグラフ表示
- **レスポンシブ**: モバイル対応デザイン

### 5. NPMパッケージ構造

```
@article-agent/context-monitor/
├── package.json           # パッケージ定義
├── README.md             # ドキュメント
├── LICENSE               # ライセンス
├── bin/                  # CLIエントリーポイント
├── src/                  # ソースコード
│   ├── core/            # コアモジュール
│   ├── hooks/           # フック実装
│   ├── dashboard/       # ダッシュボード
│   └── utils/           # ユーティリティ
├── tests/               # テストコード
└── examples/            # サンプルコード
```

## 🔧 技術的決定事項

### トークンカウント戦略
- **主要**: tiktokenライブラリ（高精度）
- **代替**: 文字数ベース推定（高速だが概算）
- **キャッシング**: 頻出テキスト用LRUキャッシュ

### データストレージ
- **主要**: SQLite（構造化データ用）
- **補助**: JSONファイル（設定とキャッシュ）
- **ログ**: ローテーティングログファイル

### リアルタイム更新
- **WebSocket**: ダッシュボードのリアルタイム更新
- **イベント駆動**: 内部イベントバス
- **スロットリング**: 最大1Hzで更新制限

### パフォーマンス最適化
- **遅延読み込み**: オンデマンドでモジュールロード
- **ワーカースレッド**: 別スレッドでトークンカウント
- **バッチ処理**: データベース書き込みをグループ化
- **圧縮**: 古いセッションデータを圧縮

## 🔐 セキュリティ考慮事項

### データ保護
- ログに機密データを含まない
- ローカルストレージのみ（外部API呼び出しなし）
- 設定可能なデータ保持期間

### アクセス制御
- デフォルトでlocalhostのみ
- オプションのダッシュボード認証
- 読み取り専用APIエンドポイント

## 🧪 テスト戦略

### ユニットテスト
- TokenCounter: 既知のトークン数での精度テスト
- ContextAnalyzer: 閾値検出テスト
- FileTracker: 冗長検出テスト
- PatternDetector: ループ検出アルゴリズムテスト

### 統合テスト
- Claude Codeとのフック統合
- 負荷下でのデータベース操作
- WebSocket接続の安定性
- NPMパッケージインストール

### パフォーマンステスト
- トークンカウント速度（目標: <10ms）
- ダッシュボード更新遅延（目標: <1秒）
- 長時間セッションでのメモリ使用量
- CPU使用率モニタリング

## 📦 デプロイメント計画

### NPM公開手順
1. webpackでビルドとバンドル
2. TypeScript定義の生成
3. npmレジストリへの公開
4. GitHubリリースの作成

### インストールプロセス
```bash
# グローバルインストール
npm install -g @article-agent/context-monitor

# または開発依存として
npm install --save-dev @article-agent/context-monitor

# プロジェクトで初期化
context-monitor init

# モニタリング開始
context-monitor start
```

## 🎯 成功指標

### パフォーマンス指標
- トークンカウント精度: ±5%
- ダッシュボード遅延: <1秒
- メモリ使用量: <50MB
- CPUオーバーヘッド: <2%

### 品質指標
- テストカバレッジ: >80%
- ドキュメントカバレッジ: 100%
- 初回リリースでの重大バグゼロ
- NPM週間ダウンロード数: >100

## 📚 依存関係

### コア依存関係
- `tiktoken`: OpenAIモデル用トークンカウント
- `sqlite3`: データベース操作
- `ws`: WebSocketサーバー
- `express`: ダッシュボードサーバー
- `chart.js`: ダッシュボード視覚化

### 開発依存関係
- `jest`: テストフレームワーク
- `webpack`: バンドリング
- `eslint`: コード品質
- `prettier`: コードフォーマット

## 🔄 移行計画

### 既存システムからの移行
1. 既存bashスクリプトをレガシーモードとして保持
2. 履歴データをSQLiteに移行
3. フック設定の更新
4. 機能フラグによる段階的展開

## 📝 ドキュメント計画

### ユーザードキュメント
- クイックスタートガイド
- 設定リファレンス
- ダッシュボードユーザーガイド
- トラブルシューティングガイド

### 開発者ドキュメント
- APIリファレンス
- フック開発ガイド
- コントリビューションガイドライン
- アーキテクチャ詳細

## ✅ 設計レビューチェックリスト

- [x] アーキテクチャが全要件をサポート
- [x] パフォーマンス目標が達成可能
- [x] セキュリティ考慮事項に対処
- [x] テスト戦略が包括的
- [x] NPMパッケージ構造定義済み
- [x] 移行パスが明確
- [ ] 人間の承認取得済み

---

## 更新履歴

| バージョン | 日付 | 変更内容 | 作成者 |
|-----------|------|---------|--------|
| 1.0 | 2025-01-09 | 初回設計 | Claude Code |